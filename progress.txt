# Ralph Progress Log
Started: Mon Jan 12 19:15:13 PST 2026
---

## 2026-01-13T03:15 - US-001
- Added User model to Prisma schema with id, email (unique), passwordHash, name, createdAt
- Made MealAnalysis.userId nullable for backward compatibility
- Added index on MealAnalysis.userId
- Added relation between User and MealAnalysis
- Generated and ran migration 20260113031542_add_user_model
- Files changed: backend/prisma/schema.prisma, backend/prisma/migrations/
- **Learnings for future iterations:**
  - Prisma schema uses cuid() for default IDs
  - Relations require both field and reference declarations
  - Migrations created with `npx prisma migrate dev --name <name>`
  - Always make userId nullable when adding to existing tables for backward compatibility
---

## 2026-01-13T03:16 - US-002
- Created auth service at backend/src/services/auth.ts
- Implemented hashPassword, verifyPassword, generateToken, verifyToken functions
- Tokens include userId and email in payload
- Token expiry set to 30 days
- JWT_SECRET read from environment variable with fallback
- Installed bcryptjs, jsonwebtoken and their type definitions
- Added JWT_SECRET to .env.example
- Files changed: backend/src/services/auth.ts, backend/.env.example, backend/package.json
- **Learnings for future iterations:**
  - Use bcrypt.hash with salt rounds (10) for password hashing
  - JWT tokens signed with expiresIn option for expiry
  - TypeScript requires @types packages for JS libraries
---

## 2026-01-13T03:17 - US-003
- Created auth middleware at backend/src/middleware/auth.ts
- Middleware validates JWT from Authorization header (Bearer token)
- Attaches user object (userId, email) to request.user
- Returns 401 for missing or invalid tokens
- Returns 403 for expired tokens (TokenExpiredError)
- Extended FastifyRequest interface to include user property
- Files changed: backend/src/middleware/auth.ts
- **Learnings for future iterations:**
  - Fastify middleware uses preHandler hooks
  - Module augmentation needed to extend FastifyRequest interface
  - JWT errors have name property to distinguish expired vs invalid
  - Authorization header format: "Bearer <token>"
---

## 2026-01-13T03:18 - US-004
- Created auth routes at backend/src/routes/auth.ts
- POST /api/auth/register - validates email/password, hashes password, creates user, returns JWT
- POST /api/auth/login - validates credentials, returns JWT on success
- Email validation using regex pattern
- Password validation (min 8 characters)
- Returns 400 for duplicate email, invalid format, or weak password
- Returns 401 for invalid credentials
- Registered auth routes in server.ts
- Regenerated Prisma client to include User model
- Files changed: backend/src/routes/auth.ts, backend/src/server.ts
- **Learnings for future iterations:**
  - Must run `npx prisma generate` after schema changes to update Prisma client types
  - Use unique constraint check before insert for better error messages
  - Return same error message for invalid email/password to prevent user enumeration
---

## 2026-01-13T03:19 - US-005
- Created user routes at backend/src/routes/user.ts
- GET /api/user/stats - protected with auth middleware
- Calculates meal count, avg calories, and totals for protein/carbs/fat
- Returns stats for three periods: today, this week, all time
- Today = midnight to now, Week = Sunday to now
- Registered user routes in server.ts
- Files changed: backend/src/routes/user.ts, backend/src/server.ts
- **Learnings for future iterations:**
  - Fastify routes use preHandler option to apply middleware
  - JSON fields from Prisma need double type assertion (as unknown as Type)
  - Week calculation: subtract getDay() to get to Sunday
  - Use filter after fetch for date range queries on small datasets
---

## 2026-01-13T03:20 - US-006
- Added auth middleware to POST /api/analyze endpoint
- Changed userId from placeholder to request.user.userId
- Imported authMiddleware in analyze.ts
- Route now returns 401 if Authorization header missing or invalid
- Files changed: backend/src/routes/analyze.ts
- **Learnings for future iterations:**
  - Apply middleware using { preHandler: authMiddleware } in route options
  - Access authenticated user via request.user (set by middleware)
  - Non-null assertion (!) safe after middleware validation
---

## 2026-01-13T03:21 - US-007
- Created User model at NutritionAI/Sources/NutritionAI/Models/User.swift
- Created UserStats model at NutritionAI/Sources/NutritionAI/Models/UserStats.swift
- User has id, email, name fields
- UserStats has today, week, allTime fields each containing PeriodStats
- PeriodStats has count, avgCalories, totalCalories, totalProtein, totalCarbs, totalFat
- Both models conform to Codable protocol
- Files changed: NutritionAI/Sources/NutritionAI/Models/User.swift, NutritionAI/Sources/NutritionAI/Models/UserStats.swift
- **Learnings for future iterations:**
  - Swift models use struct with Codable for JSON serialization
  - Nested structs for complex data structures (UserStats -> PeriodStats)
  - Build errors in other files don't block creating new models
---

## 2026-01-13T03:22 - US-008
- Created AuthService at NutritionAI/Sources/NutritionAI/Services/AuthService.swift
- ObservableObject with @Published isAuthenticated and currentUser properties
- Stores JWT token in iOS Keychain using Security framework
- Implements login(), register(), logout() methods
- Auto-login in init() by checking for valid token in Keychain
- getToken() provides access to stored token for API requests
- Keychain uses service identifier "com.nutritionai.app"
- Files changed: NutritionAI/Sources/NutritionAI/Services/AuthService.swift
- **Learnings for future iterations:**
  - iOS Keychain API uses SecItemAdd, SecItemCopyMatching, SecItemDelete
  - Delete existing token before adding new one to avoid duplicates
  - @MainActor ensures all state updates happen on main thread
  - ObservableObject for SwiftUI state management
---

## 2026-01-13T03:23 - US-009
- Updated APIService to support authentication
- Added authService property to access JWT tokens
- Created addAuthHeader() helper to add Bearer token to requests
- Added register() method - POST /api/auth/register
- Added login() method - POST /api/auth/login
- Added fetchUserStats() method - GET /api/user/stats
- analyzeImage() now includes auth header
- Handle 401 responses by calling authService.logout()
- Added unauthorized case to APIError enum
- Created AuthResponse helper struct for decoding auth responses
- Files changed: NutritionAI/Sources/NutritionAI/Services/APIService.swift
- **Learnings for future iterations:**
  - AuthService reference set externally (dependency injection)
  - Use Task { @MainActor in } to ensure UI updates on main thread
  - 401 triggers logout, 403 is expired token (backend distinction)
---

## 2026-01-13T03:24 - US-010
- Created LoginView at NutritionAI/Sources/NutritionAI/Views/LoginView.swift
- Created RegisterView at NutritionAI/Sources/NutritionAI/Views/RegisterView.swift
- LoginView has email and password fields with proper keyboard types
- RegisterView has name, email, password, confirmPassword fields
- Both show ProgressView when isLoading is true
- Error messages displayed in red below form fields
- LoginView presents RegisterView as sheet
- RegisterView has Cancel and back-to-login navigation
- Client-side validation for password match and length
- Calls authService.login/register on success which triggers navigation
- Files changed: LoginView.swift, RegisterView.swift
- **Learnings for future iterations:**
  - Use @EnvironmentObject for shared state like AuthService
  - Use @Environment(\.dismiss) for closing sheets
  - Task + await MainActor.run for async UI updates
  - SecureField for password inputs, TextField for email
---

## 2026-01-13T03:25 - US-011
- Created StatsCard component at NutritionAI/Sources/NutritionAI/Views/StatsCard.swift
- Reusable SwiftUI view with title, value, and optional subtitle
- Card-based design with system gray background
- Uses VStack for vertical layout, left-aligned
- Title in uppercase caption, value in bold title2, subtitle in caption
- Rounded corners (12pt) for modern look
- maxWidth: .infinity makes it responsive in grids
- Files changed: StatsCard.swift
- **Learnings for future iterations:**
  - Optional parameters in SwiftUI views using default nil
  - Use Color(.systemGray6) for adaptive light/dark mode backgrounds
  - .textCase(.uppercase) for title styling
  - frame(maxWidth:) for responsive grid layouts
---

## 2026-01-13T03:26 - US-012
- Created QuickCaptureTile at NutritionAI/Sources/NutritionAI/Views/QuickCaptureTile.swift
- Button-based component with SF Symbol icon and label text
- Action closure for triggering camera or other flows
- Visual feedback: scaleEffect 0.95 on tap with animation
- Uses @State isPressed for temporary press state
- DispatchQueue.main.asyncAfter for smooth animation timing
- Card design with system gray background and rounded corners
- PlainButtonStyle to avoid default button styling
- Files changed: QuickCaptureTile.swift
- **Learnings for future iterations:**
  - withAnimation wraps state changes for smooth transitions
  - DispatchQueue.main.asyncAfter delays action execution
  - scaleEffect provides tactile feedback
  - PlainButtonStyle removes default iOS button appearance
---
